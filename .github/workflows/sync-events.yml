name: Sync Events and Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'data/original/*.json'
      - 'scripts/build-all.py'
      - 'scripts/validate-event.py'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Configure Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge main into gh-pages
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin gh-pages || true
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git checkout -B gh-pages origin/gh-pages
          else
            git checkout -B gh-pages
          fi
          git merge --no-edit origin/main

      - name: Validate changed event files (gh-pages)
        shell: bash
        run: |
          set -euo pipefail
          CHANGED=$(git diff --name-only "HEAD^" "HEAD" -- 'data/original/*.json')
          if [ -z "$CHANGED" ]; then
            echo "No event files changed."
          else
            echo "Validating:"
            echo "$CHANGED"
            while IFS= read -r file; do
              [ -z "$file" ] && continue
              python3 scripts/validate-event.py "$file"
            done <<< "$CHANGED"
          fi

      - name: Build all.json
        run: |
          python3 scripts/build-all.py

      - name: Build ics files
        run: |
          python3 scripts/build-ics.py

      - name: Commit and push gh-pages
        shell: bash
        run: |
          set -euo pipefail
          git add -N data/all.json data/allevents.ics data/confirmed.ics data/tentative.ics
          git status --porcelain
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git add data/all.json data/allevents.ics data/confirmed.ics data/tentative.ics
          git commit -m "Update all.json and ics feeds"
          git push origin gh-pages
