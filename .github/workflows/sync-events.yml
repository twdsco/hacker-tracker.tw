name: Sync Events and Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'data/upcoming/**.json'
      - 'data/archive/**.json'
      - 'data/index.json'
      - 'data/all.json'
      - 'scripts/build-all.py'
      - 'scripts/validate-event.py'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Configure Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate changed event files
        shell: bash
        run: |
          set -euo pipefail
          CHANGED=$(git diff --name-only "${GITHUB_SHA}^" "${GITHUB_SHA}" -- 'data/upcoming/*.json' 'data/archive/*.json')
          if [ -z "$CHANGED" ]; then
            echo "No event files changed."
          else
            echo "Validating:"
            echo "$CHANGED"
            while IFS= read -r file; do
              [ -z "$file" ] && continue
              python3 scripts/validate-event.py "$file"
            done <<< "$CHANGED"
          fi

      - name: Sync index.json
        shell: bash
        run: |
          set -euo pipefail
          CREATED=$(git diff --name-status "${GITHUB_SHA}^" "${GITHUB_SHA}" -- 'data/upcoming/*.json' 'data/archive/*.json' | awk '$1=="A"{print $2}')
          CREATED="$CREATED" python3 scripts/sync-index.py

      - name: Build all.json
        run: |
          python3 scripts/build-all.py

      - name: Commit changes
        shell: bash
        run: |
          set -euo pipefail
          git status --porcelain
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git add data/index.json data/all.json
          git commit -m "Sync index.json and all.json"
          git push origin main

      - name: Merge main into gh-pages
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin gh-pages || true
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git checkout -B gh-pages origin/gh-pages
          else
            git checkout -B gh-pages
          fi
          git merge --no-edit origin/main
          git push origin gh-pages
